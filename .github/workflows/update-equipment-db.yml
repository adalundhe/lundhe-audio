# This is a basic workflow to help you get started with Actions

name: Update Equipment DB

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  pull_request:
    # branches: [ main ]
    paths:
        - src/data/gear.json
        - src/scripts/update_equipment.ts
        - .github/workflows/update-equipment-db.yml

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
permissions:
  actions: write
  contents: write
  issues: write
  packages: write
  pull-requests: write
  repository-projects: write
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  update_db:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          # Version Spec of the version to use in SemVer notation.
          # It also admits such aliases as lts/*, latest, nightly and canary builds
          # Examples: 12.x, 10.15.1, >=10.15.0, lts/Hydrogen, 16-nightly, latest, node
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install 
      
      - name: Update Equipment Records
        env:
          TURSO_SQLITE_DB_DATABASE_URL: ${{ secrets.TURSO_SQLITE_DB_DATABASE_URL }}
          TURSO_SQLITE_DB_TOKEN: ${{ secrets.TURSO_SQLITE_DB_TOKEN }}
        shell: bash
        run: |
          pnpm db:update:equipment
          pnpm db:dump:equipment

      - name: Create Branch and Commit
        shell: bash
        run: |
          git config --global user.email "equipment.bot@lundhe.audio"
          git config --global user.name "EquipBot"

          git remote set-url origin https://github:${{ secrets.GITHUB_TOKEN }}@github.com/adalundhe/lundhe-audio
      
          git branch update-equipment || git checkout update-equipment


          UUID=$(uuidgen)

          git push origin --delete update-equipment || true

          git config pull.rebase false

          git add -A &&
          git commit -m "EquiBot: Syncing equipment"
          git push origin update-equipment

      - name: create pull request
        shell: bash
        run: |

          UUID=$(uuidgen)

          gh pr close update-equipment || true

          gh pr create -B main -H update-equipment --title 'Equipment Sync PR' --body 'Created by Update Equipment Github Workflow'
          gh pr merge update-equipment --auto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }} 